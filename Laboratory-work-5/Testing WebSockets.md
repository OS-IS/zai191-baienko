## Тестування Веб-Сокетів
| ID |
|:-:|
| WSTG-CLNT-10 |

### Короткий опис

Протокол HTTP має суттєве обмеження у вигляді моделі запит/відповідь:
- Одне TCP-з'єднання підтримує лише одну пару запит/відповідь
- Комунікація завжди ініціюється клієнтом
- Сервер не може самостійно надіслати дані клієнту

#### Розвиток через AJAX

Технологія AJAX (Асинхронний JavaScript і XML) привнесла певні покращення:
- Можливість асинхронної взаємодії з сервером
- Оновлення даних без перезавантаження сторінки
- Проте зберігається напівдуплексний режим комунікації
- Ініціатором взаємодії все ще має бути клієнт

#### Революція веб-сокетів

[Веб-сокети](https://websockets.spec.whatwg.org/#network) представляють новий рівень веб-комунікації:
- Створення повнодуплексного каналу зв'язку
- Двостороння асинхронна комунікація
- Можливість ініціювати передачу даних як клієнтом, так і сервером

#### Технічні особливості

Процес встановлення з'єднання:
1. Початкове рукостискання через HTTP
2. Перехід на TCP-канал
3. Подальша комунікація через спеціальні фрейми

Детальну специфікацію протоколу можна знайти в документі [RFC 6455](https://datatracker.ietf.org/doc/html/rfc6455).

_Примітка: Веб-сокети забезпечують справжню двосторонню асинхронну комунікацію, що відкриває нові можливості для розробки інтерактивних веб-застосунків._

### Джерело

Сервер відповідає за перевірку [`Початковий` заголовок](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Origin) в початковому привітанні HTTP Веб-Сокет. Якщо сервер не перевіряє заголовок джерела під час початкового привітання Веб-Сокет, сервер Веб-Сокет може приймати підключення з будь-якого джерела. Це може дозволити зловмисникам обмінюватися даними з міждоменним сервером Веб-Сокет, дозволяючи виникати проблеми, подібні до CSRF. Дивіться також [Top 10-2017 A5-Порушений контроль доступу](https://owasp.org/www-project-top-ten/2017/A5_2017-Broken_Access_Control).

### Конфіденційність і Цілісність

Веб-Сокети можна використовувати через незашифрований TCP або через зашифрований TLS. Для використання незашифрованих Веб-сокетів `ws://` використовується схема URI (за замовчуванням порт 80), для використання зашифрованих (TLS) Веб-сокетів `wss://` використовується схема URI (за замовчуванням порт 443). Дивіться також [Top 10-2017 A3-Розкриття конфіденційних даних](https://owasp.org/www-project-top-ten/2017/A3_2017-Sensitive_Data_Exposure).

### Дезінфекція Входу

Як і будь-які дані, отримані з ненадійних джерел, дані мають бути належним чином оброблені та закодовані. Дивіться також [Top 10-2017 A1-Ін'єкція](https://owasp.org/www-project-top-ten/2017/A1_2017-Injection) і [Top 10-2017 A7-Міжсайтовий сценарій (XSS)](https://owasp.org/www-project-top-ten/2017/A7_2017-Cross-Site_Scripting_(XSS)).

### Цілі тестування

- Визначте використання Веб-сокетів.
- Оцініть його реалізацію, використовуючи ті самі тести на звичайних каналах HTTP.

### Як протестувати
#### Методика тестування безпеки веб-сокетів (метод чорної скриньки)

1. Виявлення веб-сокет з'єднань

Для визначення використання веб-сокетів у програмі:
- Проаналізуйте клієнтський код на наявність URI-схем `ws://` або `wss://`
- Дослідіть мережеві з'єднання через Chrome DevTools
- Використайте спеціалізовану вкладку WebSocket у [OWASP ZAP](https://www.zaproxy.org/)

2. Перевірка налаштувань з'єднання 

Перевірте обробку з'єднань сервером:
- Використовуйте спеціальний WebSocket-клієнт для спроби підключення
- При успішному з'єднанні без валідації - можлива вразливість у перевірці заголовків

3. Безпека передачі даних

При тестуванні захисту даних зверніть увагу на:
- Обов'язкове використання SSL для захищених з'єднань (схема `wss://`)
- Якість реалізації SSL:
  - Валідність сертифікатів
  - Підтримку сучасних протоколів
  - Відсутність вразливих шифрів (RC4 тощо)

Детальніше у розділі [Тестування слабкої безпеки транспортного рівня](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/09-Testing_for_Weak_Cryptography/01-Testing_for_Weak_Transport_Layer_Security)

#### Перевірка механізмів захисту

1. Аутентифікація
Проведіть стандартне тестування механізмів аутентифікації, оскільки веб-сокети не мають власних вбудованих механізмів авторизації. Дивіться розділ [Тестування аутентифікації](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/04-Authentication_Testing/README).

2. Авторизація 
Виконайте типові тести перевірки прав доступу та контролю авторизації, використовуючи стандартні методики тестування. Детальніше у розділі [Тестування авторизації](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/05-Authorization_Testing/README).

3. Валідація вхідних даних

Для тестування обробки вхідних даних:
1. Використовуйте WebSocket-вкладку [OWASP ZAP](https://www.zaproxy.org/)
2. Тестуйте різні варіанти вхідних даних
3. Перевіряйте коректність санітизації отриманої інформації
4. Звертайте увагу на обробку некоректних даних

Додаткова інформація у розділі [Тестування валідації вхідних даних](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/07-Input_Validation_Testing/README).

_Примітка: Для детальної інформації щодо конкретних видів тестування зверніться до відповідних розділів OWASP Testing Guide._

   
### Приклад 1
Після ідентифікації використання веб-сокетів у програмі, рекомендується використати [OWASP Zed Проксі-сервер атаки (ZAP)](https://www.zaproxy.org/) для перехоплення та аналізу запитів і відповідей веб-сокета. ZAP також може слугувати для модифікації та повторного відправлення веб-сокет комунікацій.
![OWASP_ZAP_Веб-Сокети](https://github.com/oleksandrblazhko/ai-191-buriak/assets/145441728/04a236a9-88cf-44b9-922a-299c315ada16)


### Приклад 2
За допомогою клієнта Веб-Сокет (його можна знайти в розділі [Інструменти] ) спробуйте підключитися до віддаленого сервера Веб-Сокет. Якщо підключення дозволено, сервер Веб-Сокет може не перевіряти заголовок походження привітання Веб-Сокета. Спробуйте відтворити раніше перехоплені запити, щоб перевірити, чи можливе міждоменне спілкування Веб-Сокет.
![Веб-Сокет_Клієнт](https://drive.google.com/file/d/1-2ndLotnEzp7ioMKSCgSLUoanjpzpsTL/view?usp=sharing)


### Тестування сірого ящика

Тестування сірого ящика частково збігається з методологією тестування чорного ящика, але з ключовою відмінністю: у випадку сірого ящика тестувальник має обмежений доступ до внутрішньої структури програми. Це зазвичай включає доступ до документації API, яка детально описує очікувані запити та відповіді через Веб-Сокети, забезпечуючи тим самим часткове уявлення про внутрішні механізми системи.

### Інструменти

- [Простий клієнт Google Chrome Веб-Сокет](https://chrome.google.com/webstore/detail/simple-websocket-client/pfdhoblngboilpfeibdedpjgfnlcodoo?hl=en)
- [Клієнт Веб-Сокет](https://github.com/ethicalhack3r/scripts/blob/master/WebSockets.html)
- [OWASP Zed Проксі-сервер атаки (ZAP)](https://www.zaproxy.org/)

### Список літератури

- [W3C - Веб-Сокет API](https://websockets.spec.whatwg.org/#network)
- [Роберт Кох - Про Веб-Сокети у тестуванні на проникнення](https://www.ub.tuwien.ac.at/dipl/2013/AC07815487.pdf)
- [DigiNinja - OWASP ZAP і Веб-Сокети](https://digi.ninja/blog/zap_web_sockets.php)
- [OWASP Web Security Testing Guide. URL] (https://owasp.org/www-project-web-security-testing-guide/stable/) 
- [Крістіан Шнайдер - міжсайтове викрадення Веб-Сокет (CSWSH)](https://christian-schneider.net/CrossSiteWebSocketHijacking.html)